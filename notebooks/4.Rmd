---
title: "4"
output:
  html_document:
    code_folding: hide
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: false  ## if you want number sections at each table header
params:
    args: myarg
---

## Setup

```{r setup-import, eval=T, hide=T}

library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(viridis)
source('../resources/aes.R')
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
load(file = '../preprocessing/data/comp.RData')
load(file = '../preprocessing/data/ords.RData')
load(file = '../preprocessing/data/tcr_analysis.RData')
obs = read.csv('../preprocessing/data/Tcell_obs.csv')
tcr = read.csv('../preprocessing/data/import/Tcell-scTCR.csv')
donor_md = read.csv('../preprocessing/data/import/metadata-donor.csv')
dir.create('../figures/4')
'../figures/4'

```

## 4C

```{r}
# Example network plots

library(igraph)
library(ggraph)
graph_from_clone2clus = function(input,attach_col=c()){

  nodes = unique(input$clone_id)
  groups = input$clus_id %>% .[!is.na(.)]

  # Initialize an empty graph
  g <- graph.empty(n = length(nodes),directed = F)

  # Add nodes from the 'samples' column
  V(g)$name <- nodes

  if ( !length(attach_col)==0 ){
    for ( col in attach_col){ V(g)[[col]] = input[[col]] }
  }

  # Add edges between samples within the same group
  for (group in unique(groups)) {
    samples_in_group <- input$clone_id[(input$clus_id == group) & (!is.na(input$clus_id))]
    if ( length(samples_in_group)==1){next}
    edges <- combn(samples_in_group, 2)
    g = add_edges(g, t(edges))
  }

  # Remove self-loops
  g <- delete.edges(g, which(ends(g, E(g))[,1] == ends(g, E(g))[,2]))

  return(g)
}

donors_pl = c('Maura_2023.PT85','Foster_2024.SMM10')
i=donors_pl[1]

as_tibble(obs) %>% select(clone_id,donor_id) %>% distinct() %>% 
  filter(donor_id==i, clone_id!='',!is.na(clone_id)) %>%
  filter(clone_id %in% tcr[tcr$clone_size>1,]$clone_id) %>% 
  left_join(tcr_analysis$clus$clon_clus) %>%
  graph_from_clone2clus() %>%
  ggraph(layout = 'fr')+geom_edge_link()+geom_node_point(size=1.5)+
  ggtitle('title')+
  coord_fixed()+
  theme_void()+theme(plot.title = element_text(hjust = 0.5, size=14))

```


## 4D

```{r fig.width=1.25, fig.height=3}

clustered = tcr_analysis$clus[['pct']] %>% mutate(diagnosis=cohort)

psuedo0 = min(clustered$clustered[clustered$clustered>0])

clustered %>% filter(diagnosis!='MGUS') %>% 
  mutate(diagnosis=factor(diagnosis,c('SMM','MM'))) %>% 
  ggplot(aes(diagnosis,log10(clustered+psuedo0),fill=diagnosis))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width=0.2,height=0,size=0.4)+
  ggpubr::stat_compare_means(comparisons = list(c('SMM','MM')),
  method = 'wilcox.test',size=3.5)+
  #scale_y_log10(limits=c(1,65),breaks=c(1,10))+
  #scale_y_continuous(limits=c(0,42.5),breaks=c(0,10,20,30,40))+
  scale_y_continuous(breaks=c(0,1,log10(50)), limits=c(0,log10(50)+0.1), labels=c(1,10,50))+
  annotation_logticks(sides='l',short=unit(0.1,'cm'),mid=unit(0.1,'cm'),long=unit(0.1,'cm'))+
  scale_fill_manual(values=diagnosis_col)+
  labs(y='% expanded repertoire clustered',title='')+
  theme_classic()+
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size=12),
    axis.title.x = element_blank(), 
    axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size=11),
    axis.title.y = element_text(size=11), 
    axis.text.y = element_text(size=11)
  )-> pl
pl


```





## SPACE 








































































































