---
title: "S6"
output:
  html_document:
    code_folding: hide
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: false  ## if you want number sections at each table header
params:
    args: myarg
---

## Setup

```{r eval=T, hide=T}
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(viridis)
source('../resources/aes.R')
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
load(file = '../preprocessing/data/comp.RData')
load(file = '../preprocessing/data/ords.RData')
load(file = '../preprocessing/data/da_results.RData')
obs = read.csv('../preprocessing/data/Tcell_obs.csv')
donor_md = read.csv('../preprocessing/data/import/metadata-donor.csv') %>% mutate(diagnosis=cohort)
#sort_id = read.csv('../resources/Foster_2024_sort_id.csv')
valid_obs = read.csv('../integration/data/validation_Tcell-obs.csv') %>%
  left_join(read.csv('../integration/data/validation_Tcell.csv')) %>%
  filter(!pheno_pred %in% c('Unknown','Myeloid','CD3_neg','Doublet')) %>%
  filter(pheno_uncertainty < 0.2)
valid_md = as_tibble(read.csv('../integration/data/validation-metadata.csv'))
dir.create('../figures/S6')
```



## S6B

Plot
```{r fig.height=3, fig.width=3}

obs.pl = valid_obs %>% mutate(pheno_pred = factor(pheno_pred, names(Tcell_pheno_colors))) 
obs.pl.med = obs.pl %>% select(pheno_pred,X_mde1,X_mde2) %>% 
  group_by(pheno_pred) %>% summarise_all(.funs = median)

obs.pl %>% 
  ggplot(aes(X_mde1,X_mde2))+
  geom_point(size=0.1,aes(color=pheno_pred))+coord_fixed()+theme_void()+
  geom_point(data = obs.pl.med, shape=21, aes(fill=pheno_pred), size=4)+
  scale_color_manual(values = Tcell_pheno_colors)+scale_fill_manual(values = Tcell_pheno_colors)+
  guides(color=guide_legend(ncol=3,override.aes = list(size=3)))+
  theme(legend.position = 'none')-> pl
pl
ggsave(plot=pl,filename = '../figures/S6/B.png',width=3,height=3, dpi="retina")

```

Legend
```{r fig.height=4, fig.width=2}

obs.pl.med %>% mutate(pheno_pred=factor(pheno_pred,rev(Tcell_order))) %>% 
  mutate(pheno=replace(pheno_pred,pheno_pred=='Treg','CD4.Treg')) %>% 
  ggplot(aes(1,0,fill=pheno_pred))+
  geom_bar(stat='identity',width=0)+
  scale_fill_manual(values=Tcell_pheno_colors)+
  guides(fill = guide_legend(ncol=1, label.position = "left",label.hjust = 1))+
  theme_void()+
  theme(
    legend.title=element_blank(),
    legend.key.size = unit(0.4, "cm"),
    legend.text=element_text(size=10),
  )->pl
pl = ggpubr::as_ggplot(ggpubr::get_legend(pl))
pl
ggsave(plot=pl,filename = '../figures/S6/B-legend.pdf',width=3,height=3, dpi="retina")

```



## S6C

```{r fig.height=3.5, fig.width=10.25}

markers = read.csv('../resources/markers.csv') %>% filter(plot=='Tcell')

dat = read.csv('../integration/data/validation_exp.csv') %>% 
  left_join(valid_obs %>% select(X,study,pheno_pred)) %>% 
  filter(!is.na(pheno_pred),pheno_pred!='Unknown') %>% 
  select(-X) %>% 
  rename(pheno=pheno_pred) %>% 
  filter(!pheno %in% c('Doublet','CD3_neg','Myeloid')) 
  
dat.sum = dat %>% 
  group_by(study,pheno) %>% summarise_all(.funs = mean) %>% 
  pivot_longer(!study:pheno,names_to='gene',values_to='mean') %>% 
  group_by(study,gene) %>% mutate(mean=range01(mean)) %>% ungroup() %>% 
  left_join(
    dat %>% 
      group_by(study,pheno) %>% summarise_all(.funs = function(i){sum(i>0)/length(i)*100}) %>% 
      pivot_longer(!study:pheno,names_to='gene',values_to='pct_exp')
  ) %>% 
  left_join(markers %>% select(gene,gene_group)) %>% filter(!is.na(gene_group)) %>% 
  mutate(gene=factor(gene,markers$gene)) %>% 
  mutate(gene_group=factor(gene_group,unique(markers$gene_group))) %>% 
  mutate(pheno=replace(pheno,pheno=='Treg','CD4.Treg')) %>% 
  left_join(data.frame(pheno=Tcell_order,subset=Tcell_subsets)) %>% 
  mutate(pheno = factor(pheno,rev(Tcell_order))) %>% 
  mutate(subset = factor(subset,c('CD4+','CD8+','Other')))


dat.sum %>% 
  ggplot(aes(gene,pheno))+
  geom_point(aes(fill=mean,size=pct_exp),shape=21)+
  scale_fill_distiller(palette = 'Reds',trans = "reverse")+
  facet_grid(subset~gene_group,scales='free',space='free')+
  scale_size(range = c(0.75,4.5))+
  labs(x='',y='')+
  theme_bw()+
  theme(
    legend.position = 'none',
    plot.title = element_text(hjust = 0.5, size=12),
    #whole plot
    axis.text.x = element_text(angle = 90, vjust = 0, hjust=1),
    panel.grid.major.x=element_blank(),panel.grid.minor.x=element_blank(),
    #facet boxes    
    strip.text.x = element_text(face = 'bold',size=8),
    strip.text.y = element_text(angle = 0,face = 'bold',size=8),
    strip.background = element_blank(),
    panel.spacing = unit(0, "lines")
  )-> pl
pl
ggsave(plot=pl,filename = '../figures/S6/C.pdf',width=10.2,height=3.5, dpi="retina")

```




## S6E

```{r fig.width=2.75, fig.height=3}

ords$valid %>% 
  left_join(valid_md %>% select(sample_id,diagnosis)) %>% 
  mutate(source='Botta et al.') %>% 
  select(source,sample_id,diagnosis,PC1) %>% 
  rbind(ords$Tcell$PCA %>% 
    left_join(comp$Tcell %>% mutate(diagnosis=cohort) %>% 
                select(sample_id,diagnosis) %>% distinct()) %>%
    mutate(source='Full dataset') %>%
    select(source,sample_id,diagnosis,PC1) %>% distinct()
  ) %>% 
  mutate(source=factor(source,c('Full dataset','Botta et al.'))) %>% 
  #scale by source
  group_by(source) %>% mutate(PC1=scale(PC1)) %>% 

  mutate(diagnosis=factor(diagnosis,c('Non','MGUS','SMM','MM'))) %>%
  
  #ggplot(aes(x = diagnosis, y = PC1, fill=diagnosis))+facet_grid(~source)+
  ggplot(aes(x = source, y = PC1, fill=diagnosis))+facet_grid(~diagnosis)+
  
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width=0.2,height=0,size=0.25)+

  ggpubr::stat_compare_means(data=. %>% filter(diagnosis=='Non'),comparisons=list(c('Full dataset','Botta et al.')),size=3.5,label.y=3)+
  ggpubr::stat_compare_means(data=. %>% filter(diagnosis=='MGUS'),comparisons=list(c('Full dataset','Botta et al.')),size=3.5,label.y=3)+
  ggpubr::stat_compare_means(data=. %>% filter(diagnosis=='SMM'),comparisons=list(c('Full dataset','Botta et al.')),size=3.5,label.y=3)+
  ggpubr::stat_compare_means(data=. %>% filter(diagnosis=='MM'),comparisons=list(c('Full dataset','Botta et al.')),size=3.5,label.y=3)+
  
  ylim(c(-3.1,4))+
  
  scale_fill_manual(values=diagnosis_col)+
  labs(title='',y='T cell skewing')+
  theme(
    legend.position='none',
    axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.title.x=element_blank(),
    plot.title = element_text(hjust = 0.5, size=12),
    strip.background = element_blank(),
    axis.title.y = element_text(size=11), axis.text.y = element_text(size=11)
  )-> pl
pl
ggsave(plot=pl,filename = '../figures/S6/E.pdf',width=2.75,height=3, dpi="retina")

```

## S6F

```{r fig.width=1.5, fig.height=3}

#All Non vs Botta every diagnosis

comp$valid %>% 
  rename(source=study) %>% 
  select(source,diagnosis,celltype,clr) %>% 
  rbind(comp$Tcell %>% filter(
    !donor_id %in% c(donors.longit,donor.Tex_hi),tissue=='BM',sampleSize>100) %>% 
    mutate(source='atlas',diagnosis=cohort) %>% select(source,diagnosis,celltype,clr)) %>% 
  mutate(source_diag = paste0(source,'_',diagnosis)) %>% 
  filter(source_diag %in% c('atlas_Non','atlas_MM','Botta2023_MM')) %>% 
  
  left_join(data.frame(
    source_diag = c('atlas_Non','atlas_MM','Botta2023_MM'),
    source_diag_pl = c('Non (full dataset)','MM (full dataset)','MM (Botta et al.)') 
  )) %>% mutate(source_diag=source_diag_pl) %>% 
  
  mutate(source_diag=factor(source_diag,
    c('Non (full dataset)','MM (full dataset)','MM (Botta et al.)'))) %>% 
  filter(celltype %in% c('CD8.TemTerm')) %>% #,'CD8.TemActive','CD4.Tn','CD4.Tem','CD8.Tn')) %>% 
  
  filter(diagnosis %in% c('Non','MM')) -> dat

dat %>% 
  ggplot(aes(x = source_diag, y = clr, fill=diagnosis))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width=0.2,height=0,size=0.2)+
  
  ggpubr::stat_compare_means(comparisons = list(
    c('Non (full dataset)','MM (full dataset)'),
    c('Non (full dataset)','MM (Botta et al.)'),
    c('MM (full dataset)','MM (Botta et al.)')),
  method = 'wilcox.test',size=3.25)+
  scale_fill_manual(values=diagnosis_col)+
  labs(y='Normalised % T cells)',title='CD8.TemTerm')+
  ylim(c(-2.1,6.5))+
  theme_classic()+
  theme(
    legend.position='none',
    axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size=10),
    axis.title.x=element_blank(),
    plot.title = element_text(hjust = 0.5, size=11),
    axis.title.y = element_text(size=11), axis.text.y = element_text(size=11)
  )-> pl
pl
ggsave(plot=pl,filename = '../figures/S6/F.pdf',width=1.5,height=3, dpi="retina")
```





# SPACE 








































































































